FaceRecognitionWASM.objectDetect = {
  
  /** DETEKSI WARNA DOMINAN PADA ROI */
  detectColor(mat) {
    const hsv = new cv.Mat();
    cv.cvtColor(mat, hsv, cv.COLOR_BGR2HSV);

    let colorName = "unknown";

    // Mask warna dasar HSV
    const colors = {
      red:    { low: [0, 100, 100], high: [10, 255, 255] },
      green:  { low: [35, 50, 50],  high: [85, 255, 255] },
      blue:   { low: [100, 80, 80], high: [130, 255, 255] },
      yellow: { low: [20, 80, 80],  high: [35, 255, 255] },
      black:  { low: [0, 0, 0],     high: [180, 255, 40] },
      white:  { low: [0, 0, 200],   high: [180, 40, 255] }
    };

    let maxPixels = 0;
    for (const key in colors) {
      const low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), colors[key].low);
      const high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), colors[key].high);
      const mask = new cv.Mat();
      cv.inRange(hsv, low, high, mask);

      const count = cv.countNonZero(mask);
      if (count > maxPixels) {
        maxPixels = count;
        colorName = key;
      }

      low.delete(); high.delete(); mask.delete();
    }

    hsv.delete();
    return colorName;
  },


  /** DETEKSI OBJEK DENGAN CONTOUR */
  detectItem(mat) {
    const gray = new cv.Mat();
    cv.cvtColor(mat, gray, cv.COLOR_BGR2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);

    const thresh = new cv.Mat();
    cv.threshold(gray, thresh, 60, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

    const contours = new cv.MatVector();
    const hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let itemDetected = null;

    if (contours.size() > 0) {
      const cnt = contours.get(0);
      const rect = cv.boundingRect(cnt);

      const aspect = rect.width / rect.height;

      const roi = mat.roi(rect);
      const color = this.detectColor(roi);

      // RULE BASED CLASSIFICATION
      if (aspect < 0.6) itemDetected = "hp";
      else if (aspect > 2.5) itemDetected = "spidol";
      else if (aspect > 1.5 && aspect < 2.5) itemDetected = "penghapusPapanTulis";
      else itemDetected = "mouse";

      roi.delete();
    }

    gray.delete();
    thresh.delete();
    contours.delete();
    hierarchy.delete();

    return itemDetected;
  }
};
